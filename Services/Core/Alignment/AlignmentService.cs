dXNpbmcgTWljcm9zb2Z0Lk9mZmljZS5Db3JlOwp1c2luZyBOTG9nOwp1c2luZyBQb3dlclBvaW50RWZmaWNpZW5jeUFkZGluLk1vZGVsczsKdXNpbmcgUG93ZXJQb2ludEVmZmljaWVuY3lBZGRpbi5Nb2RlbHMuTGljZW5zaW5nOwp1c2luZyBQb3dlclBvaW50RWZmaWNpZW5jeUFkZGluLlNlcnZpY2VzLkluZnJhc3RydWN0dXJlLk11bHRpSW5zdGFuY2U7CnVzaW5nIFBvd2VyUG9pbnRFZmZpY2llbmN5QWRkaW4uU2VydmljZXMuSW5mcmFzdHJ1Y3R1cmUuTGljZW5zaW5nOwp1c2luZyBQb3dlclBvaW50RWZmaWNpZW5jeUFkZGluLlV0aWxzOwp1c2luZyBTeXN0ZW07CnVzaW5nIFN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljOwp1c2luZyBTeXN0ZW0uTGlucTsKdXNpbmcgU3lzdGVtLldpbmRvd3MuRm9ybXM7CnVzaW5nIFBvd2VyUG9pbnQgPSBNaWNyb3NvZnQuT2ZmaWNlLkludGVyb3AuUG93ZXJQb2ludDsKCm5hbWVzcGFjZSBQb3dlclBvaW50RWZmaWNpZW5jeUFkZGluLlNlcnZpY2VzLkNvcmUuQWxpZ25tZW50CnsKICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyDmlbTliJfjg7vlhYfnva7mqZ/og73jgpLmj5DkvpvjgZnjgovjgrXjg7zjg5Pjgrnjgq/jg6njgrnjgpIKICAgIC8vLyA8L3N1bW1hcnk+CiAgICBwdWJsaWMgY2xhc3MgQWxpZ25tZW50U2VydmljZQogICAgewogICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IExvZ2dlciBsb2dnZXIgPSBMb2dNYW5hZ2VyLkdldEN1cnJlbnRDbGFzc0xvZ2dlcigpOwogICAgICAgIHByaXZhdGUgcmVhZG9ubHkgSUFwcGxpY2F0aW9uUHJvdmlkZXIgYXBwbGljYXRpb25Qcm92aWRlcjsKCiAgICAgICAgLy8gREnn対応コンストラクタ（商用レベル）CiAgICAgICAgcHVibGljIEFsaWdubWVudFNlcnZpY2UoSUFwcGxpY2F0aW9uUHJvdmlkZXIgYXBwbGljYXRpb25Qcm92aWRlcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25Qcm92aWRlciA9IGFwcGxpY2F0aW9uUHJvdmlkZXIgPz8gdGhyb3cgbmV3IEFyZ3VtZW50TnVsbEV4Y2VwdGlvbihuYW1lb2YoYXBwbGljYXRpb25Qcm92aWRlcikpOwogICAgICAgICAgICBsb2dnZXIuRGVidWcoIkFsaWdubWVudFNlcnZpY2UgaW5pdGlhbGl6ZWQgd2l0aCBESSBhcHBsaWNhdGlvbiBwcm92aWRlciIpOwogICAgICAgIH0KCiAgICAgICAgLy8g5pei5a2Y44Kz44Oz44K544OI44Op44Kv44K/77yI5b6M5pa5kupbkvaPm+aAp+e2rua MgeS/nkl+KQogICAgICAgIHB1YmxpYyBBbGlnbm1lbnRTZXJ2aWNlKCkgOiB0aGlzKG5ldyBEZWZhdWx0QXBwbGljYXRpb25Qcm92aWRlcigpKQogICAgICAgIHsKICAgICAgICAgICAgbG9nZ2VyLkRlYnVnKCJBbGlnbm1lbnRTZXJ2aWNlIGluaXRpYWxpemVkIHdpdGggZGVmYXVsdCBhcHBsaWNhdGlvbiBwcm92aWRlciIpOwogICAgICAgIH0KCiAgICAgICAgI3JlZ2lvbiDkvLjnuq7jgrDjg6vjg7zjg5cgKDctMTApCgogICAgICAgIC8vLyA8c3VtbWFyeT4KICAgICAgICAvLy8g5bem56uv44KS5o+d44GI44KL77yI77yX55qu5qn6iO3vvIkKICAgICAgICAvLy8g6YG45oqe44GX44Gf5Zu35b2i44Gu5bem56uv44KS5pyA5Yid44Gr6YG45oqe44GX44Gf5Zu35b2i77yI5Z+656iBwrLlvaLvvInjgrvoreucn+e4ruOBq+S8uOe4ruOBl+OBpuaPg+OBiOOCiyKICAgICAgICAvLy8gPC9zdW1tYXJ5PgogICAgICAgIHB1YmxpYyB2b2lkIEFsaWduU2l6ZUxlZnQoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFHbG9iYWxzLlRoaXNBZGRJbi5DaGVja0ZlYXR1cmVBY2Nlc3MoIkFsaWduU2l6ZUxlZnQiKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkFsaWduU2l6ZUxlZnQgb3BlcmF0aW9uIHN0YXJ0ZWQiKTsKCiAgICAgICAgICAgIHZhciBzZWxlY3RlZFNoYXBlcyA9IEdldFNlbGVjdGVkU2hhcGVJbmZvcygpOwogICAgICAgICAgICBpZiAoIVZhbGlkYXRlU2VsZWN0aW9uKHNlbGVjdGVkU2hhcGVzLCAyLCAwLCAi5bem56uv44KS5o+d44GI44KLIikpIHJldHVybjsKCiAgICAgICAgICAgIC8vIOacgOWIneOBq+mBuOaKnuOBl+OBn+Wbp+W9ouOCkuWfuuaupuOBqOOBl+OBpuWPluW+lwogICAgICAgICAgICB2YXIgcmVmZXJlbmNlU2hhcGUgPSBzZWxlY3RlZFNoYXBlcy5GaXJzdCgpOwogICAgICAgICAgICB2YXIgdGFyZ2V0U2hhcGVzID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5Ub0xpc3QoKTsKCiAgICAgICAgICAgIENvbUhlbHBlci5FeGVjdXRlV2l0aENvbUNsZWFudXAoKCkgPT4KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yZWFjaCAodmFyIHNoYXBlSW5mbyBpbiB0YXJnZXRTaGFwZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyDlj7Pnq6/kvY3nva7jgpLkv53mlatl+OBl+OBpuOAgeW3pueerrupuOa6luWbvuW9ouOBruW3pueerrupuOWQiOOCj+OBm+OCi++8iOS4heatveiqv+aVtO+8iQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCByaWdodFBvc2l0aW9uID0gc2hhcGVJbmZvLlJpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBzaGFwZUluZm8uU2hhcGUuTGVmdCA9IHJlZmVyZW5jZVNoYXBlLkxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlSW5mby5TaGFwZS5XaWR0aCA9IHJpZ2h0UG9zaXRpb24gLSByZWZlcmVuY2VTaGFwZS5MZWZ0OwoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLkRlYnVnKCQiU3RyZXRjaGVkIGxlZnQgZWRnZSBvZiB7c2hhcGVJbmZvLk5hbWV9IHRvIHtyZWZlcmVuY2VTaGFwZS5MZWZ0fSAo5Z+656CBOiB7cmVmZXJlbmNlU2hhcGUuTmFtZX0pIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoIChFeGNlcHRpb24gZXgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRXJyb3IoZXgsICQiRmFpbGVkIHRvIHN0cmV0Y2ggbGVmdCBlZGdlIG9mIHNoYXBlIHtzaGFwZUluZm8uTmFtZX0iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sICLlt6fnq6/jgpLmj63jgYjjgovjgrwiLCBzZWxlY3RlZFNoYXBlcy5TZWxlY3QocyA9PiBzLlNoYXBlKS5Ub0FycmF5KCkpOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oJCJBbGlnblNpemVMZWZ0IGNvbXBsZXRlZCBmb3Ige3RhcmdldFNoYXBlcy5Db3VudH0gc2hhcGVzICjln7rmiJo6IOacgOWInem4uOaKnicpIik7CiAgICAgICAgfQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOWPs+err+OCkuaPo+OBiOOCi++8iO+8mOeVquapn+iDve+8iQogICAgICAgIC8vLyDpgbjmipbjgZfjgZ/lm7flvaLjga7lj7PnsuQnjgrjgrnjgrPvop0s5pyA5Yid44Gr6YG45oqe44GX44Gf5Zu35b2i77yI5Z+656aCvuW9ou++vInjgrsvvq7nvrtxqOOBq+S8uOe4ruOBl+OBpuaPo+OBiOOCiiogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgQWxpZ25TaXplUmlnaHQoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFHbG9iYWxzLlRoaXNBZGRJbi5DaGVja0ZlYXR1cmVBY2Nlc3MoIkFsaWduU2l6ZVJpZ2h0IikpIHJldHVybjsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJBbGlnblNpemVSaWdodCBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDAsICLlj7PnsbRl+OCkuaPo+OBiOOCuiIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmupbjgajjgZfjgabluZflvpfCiAgICAgICAgICAgIHZhciByZWZlcmVuY2VTaGFwZSA9IHNlbGVjdGVkU2hhcGVzLkZpcnN0KCk7CiAgICAgICAgICAgIHZhciB0YXJnZXRTaGFwZXMgPSBzZWxlY3RlZFNoYXBlcy5Ta2lwKDEpLlRvTGlzdCgpOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3JlYWNoICh2YXIgc2hhcGVJbmZvIGluIHRhcmdldFNoYXBlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOW3pueerumjsOS9jee9ruOCkuS/neaMgasahvOBl+OBpuOAgeWPs+err+OCkuWfuuaupuWbvuW9ouOBruWPs+err+OBq+WQiOOCj+OBm+OCi++8iOS4heatveiqv+aVtO+8iQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBsZWZ0UG9zaXRpb24gPSBzaGFwZUluZm8uTGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVJbmZvLlNoYXBlLldpZHRoID0gcmVmZXJlbmNlU2hhcGUuUmlnaHQgLSBsZWZ0UG9zaXRpb247CgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRGVidWcoJCJTdHJldGNoZWQgcmlnaHQgZWRnZSBvZiB7c2hhcGVJbmZvLk5hbWV9IHRvIHtyZWZlcmVuY2VTaGFwZS5SaWdodH0gKOWfuuaupjoge3JlZmVyZW5jZVNoYXBlLk5hbWV9KSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLkVycm9yKGV4LCAkIkZhaWxlZCB0byBzdHJldGNoIHJpZ2h0IGVkZ2Ugb2Ygc2hhcGUge3NoYXBlSW5mby5OYW1lfSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgIuWPs+err+OCkuaPo+OBiOOCuiIsIHNlbGVjdGVkU2hhcGVzLlNlbGVjdChzID0+IHMuU2hhcGUpLlRvQXJyYXkoKSk7CgogICAgICAgICAgICBsb2dnZXIuSW5mbygkIkFsaWduU2l6ZVJpZ2h0IGNvbXBsZXRlZCBmb3Ige3RhcmdldFNoYXBlcy5Db3VudH0gc2hhcGVzICjln7rmiJo6IOacgOWInem4uOaKniLk+KQiKTsKICAgICAgICB9CgogICAgICAgIC8vLyA8c3VtbWFyeT4KICAgICAgICAvLy8g5LiK56uv44KS5o+d44GI44KL77yI77yZ55qu5qn6iO3vvIkKICAgICAgICAvLy8g6YG45oqe44GX44Gf5Zu35b2i44Gu5LiK56uv44KS5pyA5Yid44Gr6YG45oqe44GX44Gf5Zu35b2i77yI5Z+656aBvuW9ou++vInjgrsgvuOe4ruOBtg6NePpOOBl+OBpuaPo+OBiOOCiiKICAgICAgICAvLy8gPC9zdW1tYXJ5PgogICAgICAgIHB1YmxpYyB2b2lkIEFsaWduU2l6ZVRvcCgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiQWxpZ25TaXplVG9wIikpIHJldHVybjsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJBbGlnblNpemVUb3Agb3BlcmF0aW9uIHN0YXJ0ZWQiKTsKCiAgICAgICAgICAgIHZhciBzZWxlY3RlZFNoYXBlcyA9IEdldFNlbGVjdGVkU2hhcGVJbmZvcygpOwogICAgICAgICAgICBpZiAoIVZhbGlkYXRlU2VsZWN0aW9uKHNlbGVjdGVkU2hhcGVzLCAyLCAwLCAi5LiK56uv44KS5o+d44GI44KLIikpIHJldHVybjsKCiAgICAgICAgICAgIC8vIOacgOWIneOBq+mBuOaKnuOBl+OBn+Wbp+W9ouOCkuWfuuaupuOBqOOBl+OBpuWPluW+lwogICAgICAgICAgICB2YXIgcmVmZXJlbmNlU2hhcGUgPSBzZWxlY3RlZFNoYXBlcy5GaXJzdCgpOwogICAgICAgICAgICB2YXIgdGFyZ2V0U2hhcGVzID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5Ub0xpc3QoKTsKCiAgICAgICAgICAgIENvbUhlbHBlci5FeGVjdXRlV2l0aENvbUNsZWFudXAoKCkgPT4KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yZWFjaCAodmFyIHNoYXBlSW5mbyBpbiB0YXJnZXRTaGFwZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyDkuIvnrq/kvY3nva7jgpLkv53mjatg+OBl+OBpuOAgeS4iuerr+OCkuWfuuaupuWbvuW9ouOBruS4iuerr+OBq+WQiOOCj+OBm+OCi++8iOmBq+OBleiqv+aVtO+8iQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3R0b21Qb3NpdGlvbiA9IHNoYXBlSW5mby5Cb3R0b207CiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlSW5mby5TaGFwZS5Ub3AgPSByZWZlcmVuY2VTaGFwZS5Ub3A7CiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlSW5mby5TaGFwZS5IZWlnaHQgPSBib3R0b21Qb3NpdGlvbiAtIHJlZmVyZW5jZVNoYXBlLlRvcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5EZWJ1ZygkIlN0cmV0Y2hlZCB0b3AgZWRnZSBvZiB7c2hhcGVJbmZvLk5hbWV9IHRvIHtyZWZlcmVuY2VTaGFwZS5Ub3B9ICjln7rmiJo6IHtyZWZlcmVuY2VTaGFwZS5OYW1lfSkiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBleCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gc3RyZXRjaCB0b3AgZWRnZSBvZiBzaGFwZSB7c2hhcGVJbmZvLk5hbWV9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5LiK56uv44KS5o+d44GI44KLIiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCQiQWxpZ25TaXplVG9wIGNvbXBsZXRlZCBmb3Ige3RhcmdldFNoYXBlcy5Db3VudH0gc2hhcGVzICjln7rmiJo6IOacgOWInem4uOaKniepIik7CiAgICAgICAgfQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOS4i+err+OCkuaPo+OBiOOCi++8iO+8ke+8kOeVquapn+iDve+8iQogICAgICAgIC8vLyDpgbjmipbjgZfjgZ/lm7flvaLjga7kuIvnq6/jgpLmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLvvIjln7rmiJrnlpblvaLvvInjgrsgvuW/pue4ruOBl+OBpuaPo+OBiOOCiiogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgQWxpZ25TaXplQm90dG9tKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghR2xvYmFscy5UaGlzQWRkSW4uQ2hlY2tGZWF0dXJlQWNjZXNzKCJBbGlnblNpemVCb3R0b20iKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkFsaWduU2l6ZUJvdHRvbSBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDAsICLkuIvnq6/jgpLmj6PjgojjgorgrwiikpyByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmiJrjgajjgZfjgabluZflvpcKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuRmlyc3QoKTsKICAgICAgICAgICAgdmFyIHRhcmdldFNoYXBlcyA9IHNlbGVjdGVkU2hhcGVzLlNraXAoMSkuVG9MaXN0KCk7CgogICAgICAgICAgICBDb21IZWxwZXIuRXhlY3V0ZVdpdGhDb21DbGVhbnVwKCgpID0+CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKHZhciBzaGFwZUluZm8gaW4gdGFyZ2V0U2hhcGVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8g5LiK56uv5L2N572u44KS5L+d5oyBtatoahvOBl+OBpuOAgeS4i+err+OCkuWfuuaupuWbvuW9ouOBruS4i+err+OBq+WQiOOCj+OBm+OCi++8iOmBq+OBleiqv+aVtO+8iQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0b3BQb3NpdGlvbiA9IHNoYXBlSW5mby5Ub3A7CiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlSW5mby5TaGFwZS5IZWlnaHQgPSByZWZlcmVuY2VTaGFwZS5Cb3R0b20gLSB0b3BQb3NpdGlvbjsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5EZWJ1ZygkIlN0cmV0Y2hlZCBib3R0b20gZWRnZSBvZiB7c2hhcGVJbmZvLk5hbWV9IHRvIHtyZWZlcmVuY2VTaGFwZS5Cb3R0b219ICjln7rmiJo6IHtyZWZlcmVuY2VTaGFwZS5OYW1lfSkiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBleCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gc3RyZXRjaCBib3R0b20gZWRnZSBvZiBzaGFwZSB7c2hhcGVJbmZvLk5hbWV9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5LiL56uv44KS5o+d44GI44KLIiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCQiQWxpZ25TaXplQm90dG9tIGNvbXBsZXRlZCBmb3Ige3RhcmdldFNoYXBlcy5Db3VudH0gc2hhcGVzICjln7rmiJo6IOacgOWInem4uOaKnicpIik7CiAgICAgICAgfQoKICAgICAgICAjZW5kcmVnaW9uCgogICAgICAgICNyZWdpb24g5o6l552A44Kw44Or44O844OXICgxMS0xNCkKCiAgICAgICAgLy8vIDxzdW1tYXJ5PgogICAgICAgIC8vLyDlj7PnsbTl+OCkuW3pueerr+OBuO+8iO+8ke+8keeas+apn+iDve++vIkKICAgICAgICAvLy8g77yS44Gk44Gu5Zu35b2i44Gn44CBguefuuaupuWbvuW9ou++vIjmnIDliJ3jgavpgbjmipbvvInjgrrvpovlpJbjga7lm7flvaLjga7lj7PnsbQnjgrjgrnjgrPvopkw5Z+656aBvuWbvuW9ouOBruW3pueerripuOOBq+aOpee2gAogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgUGxhY2VSaWdodFRvTGVmdCgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiUGxhY2VSaWdodFRvTGVmdCIpKSByZXR1cm47CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiUGxhY2VSaWdodFRvTGVmdCBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDIsICLlj7PnsbTl+OCkuW3puermreOBuCIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmiJrjgajjgZfjgabluZflvpcKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuRmlyc3QoKTsKICAgICAgICAgICAgdmFyIHRhcmdldFNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5GaXJzdCgpOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyDlr77osaHlm7flvaLjga7lj7PnsbTl+OCkuWfuuaupuWbvuW9ouOBruW3pueerripuOOBq+mFjee9rgogICAgICAgICAgICAgICAgICAgIHRhcmdldFNoYXBlLlNoYXBlLkxlZnQgPSByZWZlcmVuY2VTaGFwZS5MZWZ0IC0gdGFyZ2V0U2hhcGUuV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLkRlYnVnKCQiUGxhY2VkIHt0YXJnZXRTaGFwZS5OYW1lfSByaWdodCBlZGdlIHRvIHtyZWZlcmVuY2VTaGFwZS5OYW1lfSBsZWZ0IGVkZ2UgKOWfuuaupjog5pyA5Yid6YG45oqeKeKApiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBleCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRXJyb3IoZXgsICQiRmFpbGVkIHRvIHBsYWNlIHJpZ2h0IHRvIGxlZnQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgIuWPs+err+OCkuW3pembreOBuCIsIHNlbGVjdGVkU2hhcGVzLlNlbGVjdChzID0+IHMuU2hhcGUpLlRvQXJyYXkoKSk7CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiUGxhY2VSaWdodFRvTGVmdCBjb21wbGV0ZWQgKOWfuuaupjog5pyA5Yid6YG45oqeKeKApiIpOwogICAgICAgIH0KCiAgICAgICAgLy8vIDxzdW1tYXJ5PgogICAgICAgIC8vLyDlt6Pnq6/jgpLlj7PnsbTl+OBuO+8iO+8ke+8kueas+apn+iDve+8iQogICAgICAgIC8vLyDvvJLjgaTjga7lm7flvaLjgafjgIHln7rmiJrnlpblvaLvvIjmnIDliJ3jgavpgbjmipbvvInjgrrvpovlpJbjga7lm7flvaLjga7lt6fnq6/jgpLln7rmiJrnlpblvaLjga7lj7PnsbQnjgrjgrnjgrPvopkw5o6l552ACiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBQbGFjZUxlZnRUb1JpZ2h0KCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghR2xvYmFscy5UaGlzQWRkSW4uQ2hlY2tGZWF0dXJlQWNjZXNzKCJQbGFjZUxlZnRUb1JpZ2h0IikpIHJldHVybjsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJQbGFjZUxlZnRUb1JpZ2h0IG9wZXJhdGlvbiBzdGFydGVkIik7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRTaGFwZXMgPSBHZXRTZWxlY3RlZFNoYXBlSW5mb3MoKTsKICAgICAgICAgICAgaWYgKCFWYWxpZGF0ZVNlbGVjdGlvbihzZWxlY3RlZFNoYXBlcywgMiwgMiwgIuW3peerr+OCkuWPs+err+OBuCIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmiJrjgajjgZfjgabluZflvpcKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuRmlyc3QoKTsKICAgICAgICAgICAgdmFyIHRhcmdldFNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5GaXJzdCgpOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyDlr77osaHlm7flvaLjga7lt6fnq6/jgpLln7rmiJrnlpblvaLjga7lj7PnsbTl+OBq+mFjee9rgogICAgICAgICAgICAgICAgICAgIHRhcmdldFNoYXBlLlNoYXBlLkxlZnQgPSByZWZlcmVuY2VTaGFwZS5SaWdodDsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRGVidWcoJCJQbGFjZWQge3RhcmdldFNoYXBlLk5hbWV9IGxlZnQgZWRnZSB0byB7cmVmZXJlbmNlU2hhcGUuTmFtZX0gcmlnaHQgZWRnZSAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gcGxhY2UgbGVmdCB0byByaWdodCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5bem56uv44KS5Y+z56uv44G4Iiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJQbGFjZUxlZnRUb1JpZ2h0IGNvbXBsZXRlZCAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgfQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOS4iuerr+OCkuS4i+err+OBuO+8iO+8ke+8k+eVquapn+iDve++vIkKICAgICAgICAvLy8g77yS44Gk44Gu5Zu35b2i44Gn44CBguefuuaupuWbvuW9ou++vIjmnIDliJ3jgavpgbjmipbvvInjgrrvpovlpJbjga7lm7flvaLjga7kuIrnsbQnjgrjgrnjgrPvopkw5Z+656aBvuWbvuW9ouOBruS4i+err+OBq+aOpee2gAogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgUGxhY2VUb3BUb0JvdHRvbSgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiUGxhY2VUb3BUb0JvdHRvbSIpKSByZXR1cm47CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiUGxhY2VUb3BUb0JvdHRvbSBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDIsICLkuIrnsbTl+OCkuS4i+err+OBuCIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmiJrjgajjgZfjgabluZflvpcKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuRmlyc3QoKTsKICAgICAgICAgICAgdmFyIHRhcmdldFNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5GaXJzdCgpOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyDlr77osaHlm7flvaLjga7kuIrnsbTl+OCkuWfuuaupuWbvuW9ouOBruS4i+err+OBq+mFjee9rgogICAgICAgICAgICAgICAgICAgIHRhcmdldFNoYXBlLlNoYXBlLlRvcCA9IHJlZmVyZW5jZVNoYXBlLkJvdHRvbTsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRGVidWcoJCJQbGFjZWQge3RhcmdldFNoYXBlLk5hbWV9IHRvcCBlZGdlIHRvIHtyZWZlcmVuY2VTaGFwZS5OYW1lfSBib3R0b20gZWRnZSAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gcGxhY2UgdG9wIHRvIGJvdHRvbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5LiK56uv44KS5LiL56uv44G4Iiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJQbGFjZVRvcFRvQm90dG9tIGNvbXBsZXRlZCAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgfQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOS4i+err+OCkuS4iuerr+OBuO+8iO+8ke+8lOeVquapn+iDve++vIkKICAgICAgICAvLy8g77yS44Gk44Gu5Zu35b2i44Gn44CBguefuuaupuWbvuW9ou++vIjmnIDliJ3jgavpgbjmipbvvInjgrrvpovlpJbjga7lm7flvaLjga7kuIvnsbQnjgrjgrnjgrPvopkw5Z+656aBvuWbvuW9ouOBruS4iuerr+OBq+aOpee2gAogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgUGxhY2VCb3R0b21Ub1RvcCgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiUGxhY2VCb3R0b21Ub1RvcCIpKSByZXR1cm47CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiUGxhY2VCb3R0b21Ub1RvcCBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDIsICLkuIvnsbTl+OCkuS4iuerr+OBuCIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDmnIDliJ3jgavpgbjmipbjgZfjgZ/lm7flvaLjgpLln7rmiJrjgajjgZfjgabluZflvpcKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuRmlyc3QoKTsKICAgICAgICAgICAgdmFyIHRhcmdldFNoYXBlID0gc2VsZWN0ZWRTaGFwZXMuU2tpcCgxKS5GaXJzdCgpOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyDlr77osaHlm7flvaLjga7kuIvnsbTl+OCkuWfuuaupuWbvuW9ouOBruS4iuerr+OBq+mFjee9rgogICAgICAgICAgICAgICAgICAgIHRhcmdldFNoYXBlLlNoYXBlLlRvcCA9IHJlZmVyZW5jZVNoYXBlLlRvcCAtIHRhcmdldFNoYXBlLkhlaWdodDsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRGVidWcoJCJQbGFjZWQge3RhcmdldFNoYXBlLk5hbWV9IGJvdHRvbSBlZGdlIHRvIHtyZWZlcmVuY2VTaGFwZS5OYW1lfSB0b3AgZWRnZSAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gcGxhY2UgYm90dG9tIHRvIHRvcCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5LiL56uv44KS5LiK56uv44G4Iiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJQbGFjZUJvdHRvbVRvVG9wIGNvbXBsZXRlZCAo5Z+656aGOiDmnIDliJ3pgbjmip4p4oCoIik7CiAgICAgICAgfQoKICAgICAgICAjZW5kcmVnaW9uCgogICAgICAgICNyZWdpb24g5rC05bmz5Z6C55u06Lit5aSu5o+d44GI44Kw44Or44O844OXICgxNSkKCiAgICAgICAgLy8vIDxzdW1tYXJ5PgogICAgICAgIC8vLyDmsLTlubPlnoLnm7TkuK3lpK7mjaPjgYjvvIjvvJXnlarmnarlip/og73vvIkKICAgICAgICAvLy8g6YG45oqe44GX44Gf5Zu35b2i44KS5rC05bmz44O75Z6C55u044Kn5Lit5aSu44KN5YWI5pS24oodyCiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBDZW50ZXJBbGlnbigpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiQ2VudGVyQWxpZ24iKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkNlbnRlckFsaWduIG9wZXJhdGlvbiBzdGFydGVkIik7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRTaGFwZXMgPSBHZXRTZWxlY3RlZFNoYXBlSW5mb3MoKTsKICAgICAgICAgICAgaWYgKCFWYWxpZGF0ZVNlbGVjdGlvbihzZWxlY3RlZFNoYXBlcywgMSwgMCwgIuawtOW5s+WeguebtOS4reWkrue2jeOBiCIpKSByZXR1cm47CgogICAgICAgICAgICAvLyDjgrnjg6njgqTjg4njga7kuK3lpK7kvY3nva7jgpLlj5blvpcKICAgICAgICAgICAgdmFyIHNsaWRlQ2VudGVyID0gR2V0U2xpZGVDZW50ZXJQb3NpdGlvbigpOwogICAgICAgICAgICBpZiAoc2xpZGVDZW50ZXIgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbG9nZ2VyLkVycm9yKCJGYWlsZWQgdG8gZ2V0IHNsaWRlIGNlbnRlciBwb3NpdGlvbiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBDb21IZWxwZXIuRXhlY3V0ZVdpdGhDb21DbGVhbnVwKCgpID0+CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKHZhciBzaGFwZUluZm8gaW4gc2VsZWN0ZWRTaGFwZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyDmsLTlubPlkIvlpK7jgavphY3nva4KICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVJbmZvLlNoYXBlLkxlZnQgPSBzbGlkZUNlbnRlci5WYWx1ZS5jZW50ZXJYIC0gc2hhcGVJbmZvLldpZHRoIC8gMjsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWeguebtOS4reWkruebtOmFjee9rgogICAgICAgICAgICAgICAgICAgICAgICBzaGFwZUluZm8uU2hhcGUuVG9wID0gc2xpZGVDZW50ZXIuVmFsdWUuY2VudGVyWSAtIHNoYXBlSW5mby5IZWlnaHQgLyAyOwoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLkRlYnVnKCQiQ2VudGVyZWQge3NoYXBlSW5mby5OYW1lfSBhdCAoe3NsaWRlQ2VudGVyLlZhbHVlLmNlbnRlclh9LCB7c2xpZGVDZW50ZXIuVmFsdWUuY2VudGVyWX0pIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoIChFeGNlcHRpb24gZXgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRXJyb3IoZXgsICQiRmFpbGVkIHRvIGNlbnRlciBhbGlnbiBzaGFwZSB7c2hhcGVJbmZvLk5hbWV9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAi5rC05bmz5Z6C55u044Kz5Lit5aSu5o+d44GI44KBIiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCQiQ2VudGVyQWxpZ24gY29tcGxldGVkIGZvciB7c2VsZWN0ZWRTaGFwZXMuQ291bnR9IHNoYXBlcyIpOwogICAgICAgIH0KCiAgICAgICAgI2VuZHJlZ2lvbgoKICAgICAgICAjcmVnaW9uIOOCsOODq+ODvOODl+WMluapn+iDvQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOihlOOBlOOBqOOBq+OCsOODq+ODvOODl+WMlgogICAgICAgIC8vLyDpgbjmipbjgZfjgZ/jgqrjg5bjgrjjgqfjgq/jg4jjgpLooYzliKXjgavjgrDjg6vjg7zjg5fjgrnjgovCiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBHcm91cEJ5Um93cygpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiR3JvdXBCeVJvd3MiKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkdyb3VwQnlSb3dzIG9wZXJhdGlvbiBzdGFydGVkIik7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRTaGFwZXMgPSBHZXRTZWxlY3RlZFNoYXBlSW5mb3MoKTsKICAgICAgICAgICAgaWYgKCFWYWxpZGF0ZVNlbGVjdGlvbihzZWxlY3RlZFNoYXBlcywgMiwgMCwgIuihlOOBlOOBqOOBq+OCsOODq+ODvOODl+WMliIpKSByZXR1cm47CgogICAgICAgICAgICBDb21IZWxwZXIuRXhlY3V0ZVdpdGhDb21DbGVhbnVwKCgpID0+CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IEdldEN1cnJlbnRTbGlkZSgpOwogICAgICAgICAgICAgICAgaWYgKHNsaWRlID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgRXJyb3JIYW5kbGVyLkV4ZWN1dGVTYWZlbHkoKCkgPT4KICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCLjgqLjgq/jg4bjgqPjg5bjgarjgrnjg6njgqTjg4njgYzopovjgaTjgYvjgorjgb7jgZvjgpPjgYLCiiik7CiAgICAgICAgICAgICAgICAgICAgfSwgIuihlOOBlOOBqOOBq+OCsOODq+ODvOODl+WMliIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyDopoHliKXjgavjgrDjg6vjg7zjg5fjgrkKICAgICAgICAgICAgICAgIHZhciByb3dHcm91cHMgPSBHcm91cFNoYXBlc0J5Um93cyhzZWxlY3RlZFNoYXBlcyk7CgogICAgICAgICAgICAgICAgaW50IGdyb3VwSW5kZXggPSAxOwogICAgICAgICAgICAgICAgZm9yZWFjaCAodmFyIHJvd0dyb3VwIGluIHJvd0dyb3VwcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyb3dHcm91cC5Db3VudCA+IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWbvuW9ouOCkuOCsOODq+ODvOODl+WMlgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXBlTmFtZXMgPSByb3dHcm91cC5TZWxlY3QocyA9PiBzLlNoYXBlLk5hbWUpLlRvQXJyYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncm91cFJhbmdlID0gc2xpZGUuU2hhcGVzLlJhbmdlKHNoYXBlTmFtZXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyb3VwID0gZ3JvdXBSYW5nZS5Hcm91cCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOOCsOODq+ODvOODl+WQjeOCkuiomOWumgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXAuTmFtZSA9ICQi6KGM44Kw44Or44O844OXe2dyb3VwSW5kZXh9IjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuRGVidWcoJCJDcmVhdGVkIHJvdyBncm91cCAne2dyb3VwLk5hbWV9JyB3aXRoIHtyb3dHcm91cC5Db3VudH0gc2hhcGVzIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBleCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5FcnJvcihleCwgJCJGYWlsZWQgdG8gY3JlYXRlIHJvdyBncm91cCB7Z3JvdXBJbmRleH0iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbG9nZ2VyLkluZm8oJCJHcm91cEJ5Um93cyBjb21wbGV0ZWQ6IGNyZWF0ZWQge2dyb3VwSW5kZXggLSAxfSByb3cgZ3JvdXBzIik7CiAgICAgICAgICAgIH0sICLooozkuK3jgZPjgajjgavjgrDjg6vjg7zjg5fjgrsiLCBzZWxlY3RlZFNoYXBlcy5TZWxlY3QocyA9PiBzLlNoYXBlKS5Ub0FycmF5KCkpOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkdyb3VwQnlSb3dzIGNvbXBsZXRlZCIpOwogICAgICAgIH0KCiAgICAgICAgLy8vIDxzdW1tYXJ5PgogICAgICAgIC8vLyDliJfjgZTjgajjgavjgrDjg6vjg7zjg5fjgrsgwqACiAgICAgICAgLy8vIOmBuOaKnuOBl+OBn+OCquODluOCuOOCp+OCr+ODiOOCkuWIl+WIpeOBq+OCsOODq+ODvOODl+WMluOBmeOCiyKICiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBHcm91cEJ5Q29sdW1ucygpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiR3JvdXBCeUNvbHVtbnMiKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkdyb3VwQnlDb2x1bW5zIG9wZXJhdGlvbiBzdGFydGVkIik7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRTaGFwZXMgPSBHZXRTZWxlY3RlZFNoYXBlSW5mb3MoKTsKICAgICAgICAgICAgaWYgKCFWYWxpZGF0ZVNlbGVjdGlvbihzZWxlY3RlZFNoYXBlcywgMiwgMCwgIuWIl+OBlOOBqOOBq+OCsOODq+ODvOODl+WMliIpKSByZXR1cm47CgogICAgICAgICAgICBDb21IZWxwZXIuRXhlY3V0ZVdpdGhDb21DbGVhbnVwKCgpID0+CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IEdldEN1cnJlbnRTbGlkZSgpOwogICAgICAgICAgICAgICAgaWYgKHNsaWRlID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgRXJyb3JIYW5kbGVyLkV4ZWN1dGVTYWZlbHkoKCkgPT4KICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCLjgqLjgq/jg4bjgqPjg5bjgarjgrnjg6njgqTjg4njgYzopovjgaTjgYvjgorjgb7jgZvjgpPjgYLCiiik7CiAgICAgICAgICAgICAgICAgICAgfSwgIuWIl+OBlOOBqOOBq+OCsOODq+ODvOODl+WMliIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyDliJfliKXjgavjgrDjg6vjg7zjg5fjgrngCiAgICAgICAgICAgICAgICB2YXIgY29sdW1uR3JvdXBzID0gR3JvdXBTaGFwZXNCeUNvbHVtbnMoc2VsZWN0ZWRTaGFwZXMpOwoKICAgICAgICAgICAgICAgIGludCBncm91cEluZGV4ID0gMTsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKHZhciBjb2x1bW5Hcm91cCBpbiBjb2x1bW5Hcm91cHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uR3JvdXAuQ291bnQgPiAxKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDlm7nlvaLjgpLjgrDjg6vjg7zjg5fjgrsgwqACiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcGVOYW1lcyA9IGNvbHVtbkdyb3VwLlNlbGVjdChzID0+IHMuU2hhcGUuTmFtZSkuVG9BcnJheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyb3VwUmFuZ2UgPSBzbGlkZS5TaGFwZXMuUmFuZ2Uoc2hhcGVOYW1lcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JvdXAgPSBncm91cFJhbmdlLkdyb3VwKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g44Kw44Or44O844OX5ZCN44KS6Kit5a6aCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cC5OYW1lID0gJCLliJfjgrDjg6vjg7zjg5d7Z3JvdXBJbmRleH0iOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5EZWJ1ZygkIkNyZWF0ZWQgY29sdW1uIGdyb3VwICd7Z3JvdXAuTmFtZX0nIHdpdGgge2NvbHVtbkdyb3VwLkNvdW50fSBzaGFwZXMiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLkVycm9yKGV4LCAkIkZhaWxlZCB0byBjcmVhdGUgY29sdW1uIGdyb3VwIHtncm91cEluZGV4fSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsb2dnZXIuSW5mbygkIkdyb3VwQnlDb2x1bW5zIGNvbXBsZXRlZDogY3JlYXRlZCB7Z3JvdXBJbmRleCAtIDF9IGNvbHVtbiBncm91cHMiKTsKICAgICAgICAgICAgfSwgIuWIl+OBlOOBqOOBq+OCsOODq+ODvOODl+WMliIsIHNlbGVjdGVkU2hhcGVzLlNlbGVjdChzID0+IHMuU2hhcGUpLlRvQXJyYXkoKSk7CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiR3JvdXBCeUNvbHVtbnMgY29tcGxldGVkIik7CiAgICAgICAgfQoKICAgICAgICAjZW5kcmVnaW9uCgogICAgICAgICNyZWdpb24g6ZaT6Zqy6Kiq5pW05qn6iO3gpIKgCiAgICAgICAgLy8vIDxzdW1tYXJ5PgogICAgICAgIC8vLyDplpPpmprjgpLjgarjgY/jgZkKICAgICAgICAvLy8g44Kw44Oq44OD44OJ6YWN572u44GV44KM44Gf44Kq44OW44K444Kn44Kv44OI44Gu44GZ44G544Gm44Gu6ZaT6Zqq44KS5YmK6Zmk44GX44Gm5a+G552A44GV44Gb44KLCiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBSZW1vdmVTcGFjaW5nKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghR2xvYmFscy5UaGlzQWRkSW4uQ2hlY2tGZWF0dXJlQWNjZXNzKCJSZW1vdmVTcGFjaW5nIikpIHJldHVybjsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJSZW1vdmVTcGFjaW5nIG9wZXJhdGlvbiBzdGFydGVkIik7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRTaGFwZXMgPSBHZXRTZWxlY3RlZFNoYXBlSW5mb3MoKTsKICAgICAgICAgICAgaWYgKCFWYWxpZGF0ZVNlbGVjdGlvbihzZWxlY3RlZFNoYXBlcywgMiwgMCwgIumWk+makuOCkuOBquOBj+OBmSIpKSByZXR1cm47CgogICAgICAgICAgICBDb21IZWxwZXIuRXhlY3V0ZVdpdGhDb21DbGVhbnVwKCgpID0+CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIOOCsOODquODg+ODiemFjee9ruOCkuaknOWHuuOBl+OBpumWk+makuOCkuWJiumZpAogICAgICAgICAgICAgICAgUmVtb3ZlR3JpZFNwYWNpbmcoc2VsZWN0ZWRTaGFwZXMpOwogICAgICAgICAgICAgICAgbG9nZ2VyLkluZm8oJCJSZW1vdmVTcGFjaW5nIGNvbXBsZXRlZCBmb3Ige3NlbGVjdGVkU2hhcGVzLkNvdW50fSBzaGFwZXMiKTsKICAgICAgICAgICAgfSwgIumWk+makuOCkuOBquOBj+OBmSIsIHNlbGVjdGVkU2hhcGVzLlNlbGVjdChzID0+IHMuU2hhcGUpLlRvQXJyYXkoKSk7CgogICAgICAgICAgICBsb2dnZXIuSW5mbygiUmVtb3ZlU3BhY2luZyBjb21wbGV0ZWQiKTsKICAgICAgICB9CgogICAgICAgIC8vLyA8c3VtbWFyeT4KICAgICAgICAvLy8g5Z6C55u06ZaT6Zqq6Kiq5pW0CiAgICAgICAgLy8vIOWeguebtOOBq+Wdh+esiemFjee9ruOBl+OBpuOBi+OCieioque0sOiqv+aVtOODgOOCpOOCouODreOCsOOCkuihqOekuiogICAgICAgIC8vLyA8L3N1bW1hcnk+CiAgICAgICAgcHVibGljIHZvaWQgQWRqdXN0VmVydGljYWxTcGFjaW5nKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghR2xvYmFscy5UaGlzQWRkSW4uQ2hlY2tGZWF0dXJlQWNjZXNzKCJBZGp1c3RWZXJ0aWNhbFNwYWNpbmciKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkFkanVzdFZlcnRpY2FsU3BhY2luZyBvcGVyYXRpb24gc3RhcnRlZCIpOwoKICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2hhcGVzID0gR2V0U2VsZWN0ZWRTaGFwZUluZm9zKCk7CiAgICAgICAgICAgIGlmICghVmFsaWRhdGVTZWxlY3Rpb24oc2VsZWN0ZWRTaGFwZXMsIDIsIDAsICLlnoLnm7TplpPpmprorbnosIMiKSkgcmV0dXJuOwoKICAgICAgICAgICAgQ29tSGVscGVyLkV4ZWN1dGVXaXRoQ29tQ2xlYW51cCgoKSA9PgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyDjgb7jgZrloInnm7TlnYfnrYnjgrXph43nva4gKyDlnoLnm7Tmj63jgojvvIjlt6fngrnnsbTjgorwgrXvvIkKICAgICAgICAgICAgICAgIHZhciBzb3J0ZWRTaGFwZXMgPSBzZWxlY3RlZFNoYXBlcy5PcmRlckJ5KHMgPT4gcy5Ub3ApLlRvTGlzdCgpOwogICAgICAgICAgICAgICAgdmFyIHRvcFNoYXBlID0gc29ydGVkU2hhcGVzLkZpcnN0KCk7CiAgICAgICAgICAgICAgICB2YXIgYm90dG9tU2hhcGUgPSBzb3J0ZWRTaGFwZXMuTGFzdCgpOwoKICAgICAgICAgICAgICAgIC8vIOWeguebtOaPo+OBiO+8iOW3peerr+OCkuacgOOCguW3puOBruWbvuW9ouOBq+WQiOOCj+OBm+OCi++8iQogICAgICAgICAgICAgICAgdmFyIGxlZnRtb3N0WCA9IHNvcnRlZFNoYXBlcy5NaW4ocyA9PiBzLkxlZnQpOwogICAgICAgICAgICAgICAgZm9yZWFjaCAodmFyIHNoYXBlIGluIHNvcnRlZFNoYXBlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzaGFwZS5TaGFwZS5MZWZ0ID0gbGVmdG1vc3RYOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIOWdh+etiemlbrjgg7vlvu4KICAgICAgICAgICAgICAgIERpc3RyaWJ1dGVWZXJ0aWNhbGx5KHNvcnRlZFNoYXBlcywgdG9wU2hhcGUuVG9wLCBib3R0b21TaGFwZS5Cb3R0b20pOwoKICAgICAgICAgICAgICAgIC8vIOePvuWcqOOBrumWk+makuOCkuioreevlgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTcGFjaW5nID0gQ2FsY3VsYXRlQXZlcmFnZVZlcnRpY2FsU3BhY2luZyhzb3J0ZWRTaGFwZXMpOwoKICAgICAgICAgICAgICAgIC8vIOmWk+makuiqv+aVtOODgOOCpOOCouODreOCsOOCkuihqOekuiogICAgICAgICAgICAgICAgdmFyIHNwYWNpbmdTZXR0aW5ncyA9IFNob3dWZXJ0aWNhbFNwYWNpbmdEaWFsb2coY3VycmVudFNwYWNpbmcsIHNvcnRlZFNoYXBlcyk7CiAgICAgICAgICAgICAgICBpZiAoc3BhY2luZ1NldHRpbmdzICE9IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQXBwbHlWZXJ0aWNhbFNwYWNpbmcoc29ydGVkU2hhcGVzLCBzcGFjaW5nU2V0dGluZ3MsIHRvcFNoYXBlLlRvcCwgYm90dG9tU2hhcGUuQm90dG9tKTsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuSW5mbygkIkFwcGxpZWQgdmVydGljYWwgc3BhY2luZzoge3NwYWNpbmdTZXR0aW5ncy5TcGFjaW5nfWNtLCBtZXRob2Q6IHtzcGFjaW5nU2V0dGluZ3MuQWRqdXN0bWVudE1ldGhvZH0iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsb2dnZXIuSW5mbygiQWRqdXN0VmVydGljYWxTcGFjaW5nIGNvbXBsZXRlZCIpOwogICAgICAgICAgICB9LCAi5Z6C55u06ZaT6Zqq6Kiq5pW0Iiwgc2VsZWN0ZWRTaGFwZXMuU2VsZWN0KHMgPT4gcy5TaGFwZSkuVG9BcnJheSgpKTsKCiAgICAgICAgICAgIGxvZ2dlci5JbmZvKCJBZGp1c3RWZXJ0aWNhbFNwYWNpbmcgY29tcGxldGVkIik7CiAgICAgICAgfQoKICAgICAgICAvLy8gPHN1bW1hcnk+CiAgICAgICAgLy8vIOawtOW5s+mWk+makuiqv+aVtAogICAgICAgIC8vLyDmsLTlubPjgavlnYfnrYnphY3nva7jgZfjgabjgYvjgonnialp7tsCCOiqv+aVtOODgOOCpOOCouODreOCsOOCkuihqOekuiKICiAgICAgICAgLy8vIDwvc3VtbWFyeT4KICAgICAgICBwdWJsaWMgdm9pZCBBZGp1c3RIb3Jpem9udGFsU3BhY2luZygpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUdsb2JhbHMuVGhpc0FkZEluLkNoZWNrRmVhdHVyZUFjY2VzcygiQWRqdXN0SG9yaXpvbnRhbFNwYWNpbmciKSkgcmV0dXJuOwoKICAgICAgICAgICAgbG9nZ2VyLkluZm8oIkFkanVzdEh